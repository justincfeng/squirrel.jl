#-----------------------------------------------------------------------
#       BEGIN   KerrSchild.jl
#-----------------------------------------------------------------------

#-----------------------------------------------------------------------
#   KERR-SCHILD FUNCTIONS
#-----------------------------------------------------------------------

#-----------------------------------------------------------------------
#   r squared function
#-----------------------------------------------------------------------
function rsq( X::RealVec , a::Real )
    tpfl=typeof(X[1])
    x = X[2]
    y = X[3]
    z = X[4]

    return ( -a^2 + x^2 + y^2 + z^2 + sqrt(4*(a^2)*(z^2) 
             + (-a^2 + x^2 + y^2 + z^2)^2))/2
end     #---------------------------------------------------------------

#-----------------------------------------------------------------------
#   Kerr-Schild function
#-----------------------------------------------------------------------
function fks( X::RealVec , a::Real , GM::Real=1 )
    tpfl=typeof(X[1])
    x = X[2]
    y = X[3]
    z = X[4]

    rs = rsq(X,a)
    r = sqrt(rs)
    return 2*GM*rs*r/(rs^2+(a^2)*(z^2))
end     #---------------------------------------------------------------

#-----------------------------------------------------------------------
#   k product
#-----------------------------------------------------------------------
function kks( X::RealVec , a::Real )
    tpfl=typeof(X[1])
    k = zeros(tpfl,4)
    kk = zeros(tpfl,4,4)
    x = X[2]
    y = X[3]
    z = X[4]

    rs = rsq(X,a)
    r = sqrt(rs)

    k[1] = one(tpfl)
    k[2] = (r*x+a*y)/(rs+a^2)
    k[3] = (r*y-a*x)/(rs+a^2)
    k[4] = z/r

    for i=1:4
        for j=1:4
            kk[i,j] = k[i]*k[j]
        end
    end
    return kk
end     #---------------------------------------------------------------

#-----------------------------------------------------------------------
#   KERR-SCHILD METRIC COMPONENTS
#-----------------------------------------------------------------------

#-----------------------------------------------------------------------
#   Kerr-Schild metric components
#-----------------------------------------------------------------------
function gks( X::RealVec , a::Real=0 , GM::Real=1 )
    tpfl=typeof(X[1])

    return ημν(tpfl) + fks(X,a,GM)*kks(X,a)
end     #---------------------------------------------------------------

#-----------------------------------------------------------------------
#   Metric with Earth rotation parameter
#-----------------------------------------------------------------------
function ge( X::RealVec )
    tpfl=typeof(X[1])

    a = tpfl(738)   #   This is the roughly the rotation parameter 
                    #   for Earth in units where M_Earth = 1
                    #   For reference, the avg radius of Earth is
                    #   1.437e9

    return gks(X,a,1)  
end     #---------------------------------------------------------------

#-----------------------------------------------------------------------
#       END     KerrSchild.jl
#-----------------------------------------------------------------------
